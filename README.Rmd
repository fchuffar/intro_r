---
title: "R introduction"
author: "Florent Chuffart"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---


# Purpose
This first R working session will be an introduction to your favourite statistical programming language: R. After a brief introduction to basics (user interface paradigms, free software and GNU), we will go deeply into the details of data structures, data indexing and data visualisation. The main purpose of this session is to offer a not only simple but also powerful alternative to your classical spreadsheet software. This introduction gives you the keys to perform large scale statistical data analysis.

# Prerequisistes


Chaque participant apportera son ordinateur portable sur lequel aura été installé les logiciels R et Rstudio :

 * Installer R https://cran.r-project.org/bin/windows/base/
 * Installer RStudio Desktop Open Source License https://www.rstudio.com/products/rstudio/download/

Le contenu de la session est disponible ici : https://github.com/fchuffar/intro_R



# R Software


## GNU Public Licence

R is a free software environment for statistical computing and graphics.

More details about GNU, GPL and free software here:

  - https://www.gnu.org/philosophy/free-sw.html
  - https://en.wikipedia.org/wiki/GNU_General_Public_License
  - https://en.wikipedia.org/wiki/Free_software_movement
  - https://en.wikipedia.org/wiki/CeCILL

## R and biology

R is widely used in the life science community:

  - https://www.ncbi.nlm.nih.gov/pubmed/?term=r+software

## R Community

Many packages are freely available on:

  - CRAN https://cran.r-project.org
  - Bioconductor https://www.bioconductor.org
  - GitHub https://github.com

R users are organised as a community with many help topics available on the internet.



# R CLI vs. GUI

## CLI

R could be compared to an electronic calculator. It provides not only basic operations but also advanced features allowing to manipulate distributions and visualize data.

```{r}
1+1
pi
rnorm(100)
plot(density(rnorm(100)))
```


## R GUI (RStudio) ***

https://www.rstudio.com

# Let's start with R!

## Working directory
```{r, eval=FALSE}
getwd()
# ?getwd()
# ?setwd()
```

## Organisation of your workspace

- data
- results
- src
- doc


## From a spreadsheet to R data.frame ***

```{r}
setwd("~/projects/intro_r/")
#data_sh = read.table("data/seahorse_dataset2.csv", sep=";", header=TRUE, dec=".")
data_sh = read.table("data/sp_exp_grp.csv", sep=" ", header=TRUE, dec=".")
# data_sh = read.table("http://...data/sp_exp_grp.csv", sep=" ", header=TRUE, dec=".")
head(data_sh)
tail(data_sh)
dim(data_sh)
summary(data_sh)

data_sh[1,]
data_sh[,1]

```


# Data 

## Affectation

```{r}
foo <- 1
foo

bar = "a"
bar = 'a'
bar
# bar = a
a = 4
a
bar = a
bar 

"b" -> baz
baz

quz <<- baz
```

## Common types

- numeric
- character
- logical (boolean)
- factor


```{r}
1
is.numeric(1)
0.5
is.numeric(0.5)
is.numeric("a")
foo = 1
is.numeric(foo)

a = as.integer(1)
is.integer(a)
as.integer(0.3)

"iab"
'toto'
is.numeric("a")
is.character("a")
is.character(1)
as.character(1)
as.numeric("a")

paste("a", "b", "b", sep="_")
paste("a", "b", "b", sep="")


TRUE
FALSE
T
F
T = 3
T
# TRUE = 3

is.numeric(TRUE)
as.numeric(TRUE)
as.numeric(FALSE)
as.logical(1)
as.logical(0)
as.logical(2)
as.logical(-2)
as.logical(-2.2)

is.logical("true")
is.character("true")
other_var = as.logical("true")
other_var


col_y = c("bleu", "bleu", "vert", "marron", "vert", "marron") 
col_y
as.numeric(col_y)


f = as.factor(col_y)
f
as.numeric(f)
c(f, 1)
c(f, "BLEU")
c(f, "bleu")
c(f, as.factor("vert"))
```


## Set of data

|    | Homogeneous | Heterogeneous |
|----|-------------|---------------|
| 1d |  vector     | list          |
| 2d |  matrix     | data.frame    |


```{r}
1:5
c(1,2,10)
c(1,"a",10)
c(TRUE,0)
v = rnorm(100)
v
v[c(5,18,39)]
v[98:100]



list(1,"a",10)
l = list(chr="8", tx_start=124330091, tx_end=124410705, gs="ATAD2", ref="hg19", strand="-")
l
l$chr
c(tx_start=124330091, tx_end=124410705)

m = matrix(runif(120),nrow=20)
dim(m)
m
m[20,6]
m[19:20,5:6]
m[c(17,20),]
m[,c(1,2)]
m[,c(TRUE, FALSE, TRUE, FALSE, TRUE, FALSE)]


data = data.frame(size=rnorm(25)+175, gender=sample(c("M", "F"), 25, replace=TRUE))
data[1:5,]
head(data)
data$gender

data[1,2] = "m"
data[1,2]

data[data$gender=="M",]
data[data$gender=="M" & data$size > 170,]

factor(sample(c("10", "J", "Q", "K", "A"), 25, replace=TRUE))
factor(sample(c("10", "J", "Q", "K", "A"), 25, replace=TRUE), levels=c("10", "J", "Q", "K", "A"), ordered=TRUE)
```


## Selecting lines and columns of a dataset ***

```{r}
v = 100:130
v
v[1]
v[-1]
rev(v)[1]
v[1:4]
# index by the rank
v[c(1, 4, 10, 15)]
# index by mask
col_y
col_y[c(TRUE,FALSE, TRUE, TRUE, FALSE, TRUE)]

## select a column
# by name
data_sh$id
# by rank
data_sh[,2]
data_sh[,2:6]
data_sh[,7:11]
(data_sh[,7:11]/data_sh[,2:6])
data_sh[,c(FALSE,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE, FALSE,FALSE,FALSE)]
## select a line
data_sh[1,]
# both
ctrl_j1 = data_sh[1:2,2:6]
case_j1 = data_sh[1:2,7:11]
# normalization
data_sh_norm_j1 = case_j1/ctrl_j1
data_sh_norm_j1

data_sh
for (i in 2:11) {
  if (i > 4) {
    print("It works!!")
    print(i)
  }
  print(mean(data_sh[,i], na.rm = TRUE))
}

a = 5
if (a > 4) {
  print("It works!!")
}

```


# Visualization

```{r, eval=FALSE}
hist(data$size)
abline(v=mean(data$mean))
boxplot(size~gender, data)
qnorm(data$size)
qqline(data$size)
table(data$gender)
# scatter plot
barplot(data$gender)
# b,  l, t, r
par(mar=c(10,1,1,1))
```


# Tests

## Dataset

```{r}
# dataset nutri
data_nutri = read.table("data/data_nutri.csv", sep=",", header=TRUE)
head(data_nutri)
tail(data_nutri)
# Correlation between taille and poids
plot(data_nutri$taille, data_nutri$poids, col=data_nutri$sexe)
# create index for categ.
idx_h = data_nutri$sexe == "Homme"
idx_f = data_nutri$sexe == "Femme"
# plot density of each categ.
plot(density(data_nutri$taille[idx_h]), col=2, xlim=range(data_nutri$taille))
lines(density(data_nutri$taille[idx_f]))
```
## Parametric
```{r}
# test de Shapiro-Wilks
# H0: normality
# H1: non normality
# alhpa: 5%
norm_pop = rnorm(100)
plot(density(norm_pop))
shapiro.test(norm_pop)
# pval = 0.439 > alpha = 5% 
# on concerve H0 au risque beta à calculer... 
unif_pop = runif(100)
plot(density(unif_pop))
test = shapiro.test(unif_pop)
test$p.value
# pval = 0.0001 < alpha = 5%
# on rejette H0, on accepte H1 au risque de première espèce alpha = 5%

taille_h = data_nutri$taille[idx_h]
shapiro.test(taille_h)
# pval = 9.7% > alpha = 5%
# on concerve H0 au risque beta à calculer... beta contrôlé dans le cas de shapiro.test.

taille_f = data_nutri$taille[idx_f]
shapiro.test(taille_f)
# pval = 11% > alpha = 5%
# on concerve H0 au risque beta à calculer... beta contrôlé dans le cas de shapiro.test.


# Homoscedasticity
# H0: homoscedasticity
# H1: non homoscedasticity
# alpha: 5%

# egalité des variances
bartlett.test(
  rnorm(200, 0, 1), 
  c(rep("a", 100), rep("b", 100))
)
# pval > 5% donc je conserve H0 au rosque beta à calculer

# non egalité des variances
bartlett.test(
  c(rnorm(100, 0, 10), rnorm(100, 0, 1)), 
  c(rep("a", 100), rep("b", 100))
)
# pval < 5% donc je rejette H0 et j'accepte H1 au risque alpha de 5%.

bartlett.test(data_nutri$taille, data_nutri$sexe)
# pval = 16% donc je conserve H0 au seuil beta à calculer.


# Student test, t test, 
# H0: t_h == t_f
# H1: t_h != t_f
# alpha: 5%
t.test(taille_h, taille_f, conf.level = 0.95)
# pval = 2.2e-16 << 5% on rejette H0 et on accepte H1 au seuil alpha de 5%. 


# H0: t_h == t_f
# H1: t_h > t_f
# alpha: 5%
t.test(taille_h[1:10], taille_f[1:10], conf.level = 0.95, alternative="greater")
# pval = 2.2e-16 << 5% on rejette H0 et on accepte H1 au seuil alpha de 5%. 


# H0: t_h == t_f
# H1: t_h < t_f
# alpha: 5%
t.test(taille_h, taille_f, conf.level = 0.95, alternative="less")
# pval = 1 >> 5% on conserve H0 au risque beta, à calculer... 


```
# Non parametric
```{r}
# H0: t_h == t_f
# H1: t_h != t_f
# alpha: 5%
wilcox.test(taille_h[1:10], taille_f[1:10], alternative = "two.side") # Mann Withney
# pval = 0.0001 < alpha = 5% donc je rejette H0 et j'accepte H1 au seuil alpha de 5%


# H0: t_h == t_f
# H1: t_h > t_f
# alpha: 5%
test = wilcox.test(taille_h[1:10], taille_f[1:10], alternative = "greater") # Mann Withney
# pval = 0.00008 < alpha = 5% donc je rejette H0 et j'accepte H1 au seuil alpha de 5%



if (test$p.value < 0.001) {
label = paste(signif(test$p.value,2), "***")
} else if (test$p.value < 0.01) {
label = paste(signif(test$p.value,2), "**") 
} else if (test$p.value < 0.05) {
label = paste(signif(test$p.value,2), "*") 
} else {
label = signif(test$p.value,2)
}
plot(density(data_nutri$taille[idx_h]), col=2, xlim=range(data_nutri$taille))
lines(density(data_nutri$taille[idx_f]))
text(165,0.04, labels=label)

boxplot(data_nutri$taille~data_nutri$sex, las=2)
text(1.5,180, labels=label)

```

## Empirical p-value 


```{r}
stat_obs = wilcox.test(unique(taille_h)[1:5], unique(taille_f)[1:5], alternative = "two.side")$statistic # Mann Withney
 
stat_rnds = sapply(1:10000, function(i) {  
  rnd_pop = sample(c(unique(taille_h)[1:5], unique(taille_f)[1:5]))
  stat_rnd = wilcox.test(rnd_pop[1:5], rnd_pop[6:10], alternative = "two.side")$statistic # Mann Withney
  return(stat_rnd)
})

pval_emp = (sum(stat_rnds > stat_obs) + 1)/length(stat_rnds)
print(pval_emp)

plot(density(stat_rnds))
abline(v=stat_obs)
```

# Statistical test

```{r, eval=FALSE}
plot_null = function(n, mean=0, sd=1, thresh=TRUE, ...){
  foo = sapply(1:10000, function(i) {
    bar = rnorm(n, mean, sd)
    m = mean(bar)
    s = sd(bar)
    c(mean=m, sd = s)
  })
  foo = data.frame(t(foo))
  t = foo$mean / (foo$sd / sqrt(10))  
  lines(density(foo$mean), ...)
  if (thresh) abline(v=quantile(foo$mean, c(0.025,0.975)), lty=2, ...)
  # lines(density(t), lty=2, ...)
  # lines(density(rt(10000, n-1)), col="grey", lty=3)
}

layout(matrix(1:2, 1), respect=TRUE)
plot(0,0,col=0,xlim=c(-1,1), ylim=c(0,2))
plot_null(10)
plot_null(10,mean=0.25, thresh=FALSE, col=4)
# plot_null(20, col=2)

plot(0,0,col=0,xlim=c(-1,1), ylim=c(0,2))
plot_null(30)
plot_null(30,mean=0.25, thresh=FALSE, col=4)
# plot_null(20, col=2)



# H0: m == 0
# H1: m != 0
# alpha = P(reject H0 | H0 is true)
# beta = P(accept H0 | H0 is false)
```

# To go further with R

## Scripts

```{r, eval=FALSE}
source("intro_r.R")
```



## Functions

### Common functions

```{r}
x = c(1,2,3,4,5)
y = c(2,4,6,8,10)
length(x)
plot(x,y)

rnd = runif(100000)
dices = round(rnd * 6)
table(dices)
barplot(table(dices))
dices = floor(rnd * 6)
barplot(table(dices))
dices = ceiling(rnd * 6)
barplot(table(dices))
pie(table(dices))

mat_5_dices = matrix(dices,5)
dim(mat_5_dices)
mat_5_dices[,1:10]

sum_5_dices = apply(mat_5_dices, 2, sum)
table(sum_5_dices)
barplot(table(sum_5_dices))


prop.table(table(sum_5_dices))
prop.table(table(sum_5_dices))
sum(prop.table(table(sum_5_dices)))
```

```{r, eval=FALSE}
?ls()
?paste()

?sum()    
?cumsum() 
?sqrt()   

?rnorm()
?qnorm()
?pnorm()

?cbind()
?rbind()

?sort()
?order()
?grep()

?read.table()
?write.table()

```

### Custom functions

  - signature (parameter)
  - return
  - scope and global variables
  

```{r}

hello_world = function(name="world") {
  ret = paste("Hello ", name, "!", sep="")
  return(ret)  
}

hello_world()

```




  


 

## Control structure

A control structure is a block of programming that analyzes variables and chooses a direction in which to go based on given parameters.
  


## Algorithm

  An algorithm is a self-contained sequence of actions to be performed. 
  An algorithm is an effective method that can be expressed within a finite amount of space and time.

# References


http://adv-r.had.co.nz

http://r-pkgs.had.co.nz

# Exercices 

http://graal.ens-lyon.fr/~fchuffart/files/data/exercices.pdf
